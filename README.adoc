= How to setup `spring-data-aerospike` in Spring Boot application

This repository contains sample project for demonstration of `spring-data-aerospike` setup and usage.

NOTE: This project requires JDK 11. You can download it https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html[here].

== Setting up the project

In this section we'll cover setup of the project from the start.

First, we'll need to setup the basic project structure.
You can do it either manually if you are familiar with the process or do it via https://start.spring.io/[Spring Initializr].

In Spring Initializr you'll need to select:

- Project: https://stackoverflow.com/a/13335439/688926[Maven] project
- Language: Java
- https://spring.io/projects/spring-boot[Spring Boot]: 2.2
- Java: 11

.Options to select
image::docs/images/spring-initializr.png[height=400]

Press Generate button in the bottom of the page and you'll get zip with initial project. Import project into your
favorite IDE and run the test. It should be green and that means that you are ready to continue to the next section.

== Adding `spring-data-aerospike` dependency

[NOTE]
====
`spring-data-aerospike` is a Community project and the dependency is not managed by Spring, it has it's own release cycle
and is not included into Spring Boot dependency management. Available versions can be checked on
https://mvnrepository.com/artifact/com.aerospike/spring-data-aerospike[Maven Central].

https://github.com/aerospike-community/spring-data-aerospike#spring-boot-compatibility[Spring Boot compatibility] can be
checked for the version of `spring-data-aerospike` that is compatible with specific Spring Boot version.
====

In our case we are going to use `spring-data-aerospike` 2.3.0.RELEASE as we have Spring Boot 2.2.

Add `spring-data-aerospike` to the
https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#Dependency_Management[`dependencyManagement`]
and `dependencies` sections of your `pom.xml`:

.pom.xml
[source,xml]
----
    <dependencyManagement>
        <dependencies>
            <!-- https://mvnrepository.com/artifact/com.aerospike/spring-data-aerospike -->
            <dependency>
                <groupId>com.aerospike</groupId>
                <artifactId>spring-data-aerospike</artifactId>
                <version>2.3.0.RELEASE</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
    <!-- Other dependencies omitted-->
        <dependency>
            <groupId>com.aerospike</groupId>
            <artifactId>spring-data-aerospike</artifactId>
        </dependency>
    <!-- Other dependencies omitted-->
    </dependencies>
----

== Creating Aerospike repository

We will be using https://projectlombok.org/[Lombok] library to omit the boilerplate code in the entity class.
Add `lombok` into your `pom.xml`:

.pom.xml
[source,xml]
----
    <dependencies>
    <!-- Other dependencies omitted-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <scope>provided</scope>
        </dependency>
    <!-- Other dependencies omitted-->
    </dependencies>
----

We are going to use the movies domain in this project, so to be able to read and save our movies into Aerospike we will need to create:

. document(entity) class that represents our domain model,
. repository class that provides https://en.wikipedia.org/wiki/CRUD[CRUD] operations.

Movie document class will look the following way:

.MovieDocument.java
[source,java]
----
package com.example.demo.persistence;

import lombok.Value;
import org.springframework.data.aerospike.mapping.Document;
import org.springframework.data.aerospike.mapping.Field;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Version;

import java.util.List;

@Value // <1>
@Document // <2>
public class MovieDocument {

    @Id // <3>
    String id;

    @Field // <4>
    String name;

    @Field("desc") // <5>
    String description;

    @Field
    double rating;

    @Field
    List<PersonDocument> stars;

    @Version // <6>
    long version;
}
----

Document explained:

<1> https://projectlombok.org/features/Value[`@Value`] makes class immutable, all fields are made private and final,
`toString()`, `equals()`, `hashCode()`, field getters and all args constructor are generated.

<2> `@Document` marks a class as an entity to be persisted to Aerospike. It also allows to specify set name, expiration and touch on read values.

<3> `@Id` marks a field as the primary key.

<4> `@Field` is optional, can be set just for the clarity purpose.

<5> `@Field("desc")` configures the name of a field to be used when persisting the document.

<6> `@Version` enables optimistic locking, so that concurrent updates are not lost when saving an entity.

[NOTE]
====
Aerospike has https://www.aerospike.com/docs/guide/limitations.html[limitation] on the bin name length.
If your document contains field with name that exceeds this limit, specify short name in `@Field` annotation:
----
    @Field("shortName")
    String veryLoooongFieldName;
----
====

Create Movie Repository interface:

----
package com.example.demo.persistence;

import org.springframework.data.repository.CrudRepository;

public interface MovieRepository extends CrudRepository<MovieDocument, String> { // <1>
}
----


Repository explained:

<1> `CrudRepository` provides sophisticated CRUD functionality for the entity class.

== Configuring connection to Aerospike

//TODO: autoconfiguration coming soon. Add link to repo

To configure connection to Aerospike you'll need to create configuration class that extends `AbstractAerospikeDataConfiguration`.
Basic setup requires `getHosts()` and `namespace()` methods to be implemented,
but you can also override e.g. `getClientPolicy()` to specify custom configuration for the Aerospike client,
or `customConverters()` to add custom converters.

We are going to use
https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config-typesafe-configuration-properties[`@ConfigurationProperties`]
for binding Aerospike configuration properties to POJO. Since connection parameters are required, configuration needs to be validated.
To enable validation add `hibernate-validator` dependency to `pom.xml`:

.pom.xml
[source,xml]
----
    <dependencies>
    <!-- Other dependencies omitted-->
        <dependency>
            <groupId>org.hibernate.validator</groupId>
            <artifactId>hibernate-validator</artifactId>
        </dependency>
    <!-- Other dependencies omitted-->
    </dependencies>
----

Simple configuration will look the following way:

.AerospikeConfiguration.java
[source,java]
----
package com.example.demo.persistence;

import com.aerospike.client.Host;
import lombok.Data;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.aerospike.config.AbstractAerospikeDataConfiguration;
import org.springframework.validation.annotation.Validated;

import javax.validation.constraints.NotEmpty;
import java.util.Collection;
import java.util.Set;

@EnableConfigurationProperties(AerospikeConfiguration.AerospikeConfigurationProperties.class)
@Configuration
public class AerospikeConfiguration extends AbstractAerospikeDataConfiguration {

    @Autowired
    private AerospikeConfigurationProperties properties;

    @Override
    protected Collection<Host> getHosts() {
        return properties.getHosts();
    }

    @Override
    protected String namespace() {
        return properties.getNamespace();
    }

    @Data
    @Validated // add this annotation if you want @ConfigurationProperties to be validated!
    @ConfigurationProperties("aerospike")
    public static class AerospikeConfigurationProperties {

        @NotEmpty
        Set<Host> hosts;

        @NotEmpty
        String namespace;
    }
}
----

Now when you run `contextLoads` test you'll get exception:
----
Caused by: org.springframework.boot.context.properties.bind.validation.BindValidationException: Binding validation errors on aerospike
   - Field error in object 'aerospike' on field 'hosts': rejected value [null]; ...(message omitted)
   - Field error in object 'aerospike' on field 'namespace': rejected value [null]; ...(message omitted)
----

This is expected! As you remember we've added `hibernate-validator` dependency and annotated `AerospikeConfigurationProperties` fields with `@NotEmpty`. 
Spring was not able to find neither `aerospike.hosts` nor `aerospike.namespace` properties. We are going to fix that in the next section.

== Testing

//TODO

== Handling errors

//TODO

== Advanced features

- Creating index
- Fetching data by secondary index
- Custom `clientPolicy` for Aerospike client
- Custom converters
- Composite primary key